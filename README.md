# 売上予測アンサンブルモデル

## 概要

このプロジェクトは、店舗の売上を高精度に予測するための高度なアンサンブル機械学習モデルを実装したものです。特に予測値が高額になるテール部分の予測精度向上を目的として、分類モデルと回帰モデルを組み合わせた多層的なアプローチを採用しています。

## 特徴

-   **多層アンサンブルアーキテクチャ**: 複数のモデルを段階的に組み合わせることで、予測の頑健性と精度を向上させます。
-   **ゲート分類器**: 最初に売上を「低」「中」「高」の3つのカテゴリに分類し、それぞれの確率を後段のモデルの特徴量として利用します。
-   **専門家モデル (Experts)**: 特性の異なる複数の回帰モデル（LightGBM, CatBoost, Ridge, Tweedie）をベース学習器として使用します。
-   **Mixture of Experts**: ゲート分類器の確率と各カテゴリの代表値（中央値）を用いて、堅牢な予測値を生成します。
-   **Blending & Stacking**:
    -   **Blending**: 各モデルの予測値を、Pinball Lossを最小化するように最適化された重みで加重平均します。
    -   **Stacking**: 各モデルの予測値を特徴量として、`QuantileRegressor` を用いたメタモデルを学習させます。
-   **Out-of-Fold (OOF) 予測**: すべてのモデルはOOF（Out-of-Fold）で学習・予測を行うことで、データリークを防ぎ、後段のモデルで安全に特徴量として利用できます。

## セットアップ方法

1.  **仮想環境の作成**
    ```bash
    python -m venv venv
    ```

2.  **仮想環境のアクティベート**
    -   Windows (PowerShell):
        ```bash
        .\venv\Scripts\Activate.ps1
        ```
    -   macOS / Linux:
        ```bash
        source venv/bin/activate
        ```

3.  **必要なライブラリのインストール**
    ```bash
    pip install -r requirements.txt
    ```

## 実行方法

以下のコマンドで、アンサンブルモデルの学習と予測パイプライン全体を実行します。

```bash
python lightgbm_sales_prediction.py
```

スクリプトを実行すると、モデルの学習、OOF予測の生成、評価、可視化が順次行われます。処理には数分かかる場合があります。

## アンサンブルモデルの構造

このモデルは、以下のステップで構成されています。

1.  **ゲート分類 (Gating)**: LightGBM分類器が、各データポイントの売上が「低」「中」「高」のいずれのカテゴリに属するか、その確率を予測します。
2.  **ベース回帰器 (Base Regressors)**: 多様な回帰モデル群（LightGBM, CatBoost, Ridge, Tweedie）が、OOFで売上を予測します。
3.  **Mixtureモデル**: ステップ1の確率と各カテゴリの売上中央値を使い、重み付き和で予測値を計算します。
4.  **ブレンディング (Blending)**: ステップ2と3で得られた全てのOOF予測値を入力とし、Pinball Lossを最小化する重みで統合します。
5.  **スタッキング (Stacking)**: ステップ2と3のOOF予測値を特徴量として、メタモデル（QuantileRegressor）を学習させます。
6.  **最終統合 (Final Blend)**: ステップ4（Blending）とステップ5（Stacking）の予測値を、再度Pinball Lossで重みを最適化しながら最終的な予測値を算出します。

## 出力

スクリプトの実行が完了すると、以下のファイルが生成されます。

-   `ensemble_oof_predictions.csv`:
    -   元のデータに加えて、パイプラインの各ステージで生成された全てのOOF予測値（ゲート確率、各ベースモデル予測、Mixture予測、Blend予測、Stack予測、最終予測）が列として追加されたCSVファイルです。
-   各種プロット画像:
    -   ゲート分類器の混合行列
    -   最終予測値と実績値の散布図
    -   残差の分布を示すヒストグラム
